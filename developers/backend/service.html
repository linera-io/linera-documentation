<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Writing the Service Binary</title>


        <!-- Custom HTML head -->

        <meta name="description" content="The Linera Manual">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../../favicon-de23e50b.svg">
        <link rel="shortcut icon" href="../../favicon-8114d1fc.png">
        <link rel="stylesheet" href="../../css/variables-d0866e17.css">
        <link rel="stylesheet" href="../../css/general-e9745eeb.css">
        <link rel="stylesheet" href="../../css/chrome-d7ced664.css">
        <link rel="stylesheet" href="../../css/print-ad67d350.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../FontAwesome/css/font-awesome-799aeb25.css">
        <link rel="stylesheet" href="../../fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../../highlight-493f70e1.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../../tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../../ayu-highlight-56612340.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../theme/theme-864c5258.css">
        <link rel="stylesheet" href="../.././mdbook-admonish.css">


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../../toc-68d988ca.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const html = document.documentElement;
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/linera-io/linera-documentation" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        <a href="https://github.com/linera-io/linera-documentation/edit/main/src/developers/backend/service.md" title="Suggest an edit" aria-label="Suggest an edit">
                            <i id="git-edit-button" class="fa fa-edit"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="writing-the-service-binary"><a class="header" href="#writing-the-service-binary">Writing the Service Binary</a></h1>
<p>The service binary is the second component of a Linera application. It is
compiled into a separate Bytecode from the contract and is run independently. It
is not metered (meaning that querying an application's service does not consume
gas), and can be thought of as a read-only view into your application.</p>
<p>Application states can be arbitrarily complex, and most of the time you don't
want to expose this state in its entirety to those who would like to interact
with your app. Instead, you might prefer to define a distinct set of queries
that can be made against your application.</p>
<p>The <code>Service</code> trait is how you define the interface into your application. The
<code>Service</code> trait is defined as follows:</p>
<pre><code class="language-rust ignore">pub trait Service: WithServiceAbi + ServiceAbi + Sized {
    /// Immutable parameters specific to this application.
    type Parameters: Serialize + DeserializeOwned + Send + Sync + Clone + Debug + 'static;

    /// Creates an in-memory instance of the service handler.
    async fn new(runtime: ServiceRuntime&lt;Self&gt;) -&gt; Self;

    /// Executes a read-only query on the state of this application.
    async fn handle_query(&amp;self, query: Self::Query) -&gt; Self::QueryResponse;
}</code></pre>
<p>Let's implement <code>Service</code> for our counter application.</p>
<p>First, we create a new type for the service, similarly to the contract:</p>
<pre><code class="language-rust ignore">linera_sdk::service!(CounterService);

pub struct CounterService {
    state: CounterState,
    runtime: Arc&lt;ServiceRuntime&lt;Self&gt;&gt;,
}</code></pre>
<p>Just like with the <code>CounterContract</code> type, this type usually has two types: the
application <code>state</code> and the <code>runtime</code>. We can omit the fields if we don't use
them, so in this example we're omitting the <code>runtime</code> field, since its only used
when constructing the <code>CounterService</code> type.</p>
<p>As before, the macro <code>service!</code> generates the necessary boilerplate for
implementing the service
<a href="https://component-model.bytecodealliance.org/design/wit.html">WIT interface</a>,
exporting the necessary resource types and functions so that the service can be
executed.</p>
<p>Next, we need to implement the <code>Service</code> trait for <code>CounterService</code> type. The
first step is to define the <code>Service</code>'s associated type, which is the global
parameters specified when the application is instantiated. In our case, the
global parameters aren't used, so we can just specify the unit type:</p>
<pre><code class="language-rust ignore">impl Service for CounterService {
    type Parameters = ();

    // ...
}</code></pre>
<p>Also like in contracts, we must implement a <code>load</code> constructor when implementing
the <code>Service</code> trait. The constructor receives the runtime handle and should use
it to load the application state:</p>
<pre><code class="language-rust ignore">    async fn new(runtime: ServiceRuntime&lt;Self&gt;) -&gt; Self {
        let state = CounterState::load(runtime.root_view_storage_context())
            .await
            .expect("Failed to load state");
        CounterService {
            state,
            runtime: Arc::new(runtime),
        }
    }</code></pre>
<p>Services don't have a <code>store</code> method because they are read-only and can't
persist any changes back to the storage.</p>
<p>The actual functionality of the service starts in the <code>handle_query</code> method. We
will accept GraphQL queries and handle them using the
<a href="https://github.com/async-graphql/async-graphql"><code>async-graphql</code> crate</a>. To
forward the queries to custom GraphQL handlers we will implement in the next
section, we use the following code:</p>
<pre><code class="language-rust ignore">    async fn handle_query(&amp;self, request: Request) -&gt; Response {
        let schema = Schema::build(
            QueryRoot {
                value: *self.state.value.get(),
            },
            MutationRoot {
                runtime: self.runtime.clone(),
            },
            EmptySubscription,
        )
        .finish();
        schema.execute(request).await
    }</code></pre>
<p>Finally, as before, the following code is needed to incorporate the ABI
definitions into your <code>Service</code> implementation:</p>
<pre><code class="language-rust ignore">impl WithServiceAbi for CounterService {
    type Abi = counter::CounterAbi;
}</code></pre>
<h2 id="adding-graphql-compatibility"><a class="header" href="#adding-graphql-compatibility">Adding GraphQL compatibility</a></h2>
<p>Finally, we want our application to have GraphQL compatibility. To achieve this
we need a <code>QueryRoot</code> to respond to queries and a <code>MutationRoot</code> for creating
serialized <code>Operation</code> values that can be placed in blocks.</p>
<p>In the <code>QueryRoot</code>, we only create a single <code>value</code> query that returns the
counter's value:</p>
<pre><code class="language-rust ignore">struct QueryRoot {
    value: u64,
}

#[Object]
impl QueryRoot {
    async fn value(&amp;self) -&gt; &amp;u64 {
        &amp;self.value
    }
}</code></pre>
<p>In the <code>MutationRoot</code>, we only create one <code>increment</code> method that returns a
serialized operation to increment the counter by the provided <code>value</code>:</p>
<pre><code class="language-rust ignore">struct MutationRoot {
    runtime: Arc&lt;ServiceRuntime&lt;CounterService&gt;&gt;,
}

#[Object]
impl MutationRoot {
    async fn increment(&amp;self, value: u64) -&gt; [u8; 0] {
        self.runtime.schedule_operation(&amp;value);
        []
    }
}</code></pre>
<p>We haven't included the imports in the above code. If you want the full source
code and associated tests check out the <a href="https://github.com/linera-io/linera-protocol/blob/300ba6d6a015d93a837296004e5958f843452248/examples/counter/src/service.rs">examples
section</a> on
GitHub.</p>
<h2 id="references"><a class="header" href="#references">References</a></h2>
<ul>
<li>
<p>The full trait definition of <code>Service</code> can be found
<a href="https://github.com/linera-io/linera-protocol/blob/300ba6d6a015d93a837296004e5958f843452248/linera-sdk/src/lib.rs">here</a>.</p>
</li>
<li>
<p>The full <code>Counter</code> example application can be found
<a href="https://github.com/linera-io/linera-protocol/blob/300ba6d6a015d93a837296004e5958f843452248/examples/counter">here</a>.</p>
</li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../developers/backend/contract.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../../developers/backend/deploy.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../developers/backend/contract.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../../developers/backend/deploy.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../elasticlunr-ef4e11c1.min.js"></script>
        <script src="../../mark-09e88c2c.min.js"></script>
        <script src="../../searcher-b074573a.js"></script>

        <script src="../../clipboard-1626706a.min.js"></script>
        <script src="../../highlight-abc7f01d.js"></script>
        <script src="../../book-ba43d0c1.js"></script>

        <!-- Custom JS scripts -->
        <script src="../../custom-6e1704cf.js"></script>
        <script src="../../mermaid-eefea253.min.js"></script>
        <script src="../../mermaid-init-4a2716e5.js"></script>


    </div>
    </body>
</html>
